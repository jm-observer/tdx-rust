# 通达信协议解析文档

## 目录

- [通讯方式](#通讯方式)
- [协议帧格式](#协议帧格式)
- [消息类型](#消息类型)
- [数据编码规则](#数据编码规则)
- [业务消息格式](#业务消息格式)
- [连接与心跳](#连接与心跳)

---

## 通讯方式

### 连接方式

- **协议**: TCP
- **端口**: 7709
- **编码**: 二进制协议，小端序（Little-Endian）
- **压缩**: 响应数据使用 zlib 压缩（当压缩长度 ≠ 未压缩长度时）

### 服务器地址

通达信服务器分布在全国多个城市，默认端口为 7709：

- **上海**: 124.71.187.122, 122.51.120.217, 111.229.247.189 等
- **北京**: 121.36.54.217, 121.36.81.195, 123.249.15.60 等
- **广州**: 124.71.85.110, 139.9.51.18, 139.159.239.163 等
- **武汉**: 119.97.185.59

### 连接流程

1. 建立 TCP 连接
2. 发送连接请求（TypeConnect）
3. 接收连接响应
4. 启动心跳机制（每30秒发送一次心跳包）
5. 开始业务数据交互

---

## 协议帧格式

### 请求帧（Request Frame）

请求帧由客户端发送到服务器，格式如下：

```
+--------+--------+--------+--------+--------+--------+--------+--------+
| Prefix | MsgID  | Control| Length | Length | Type   | Data   |
| (1字节) | (4字节) | (1字节) | (2字节) | (2字节) | (2字节) | (变长) |
+--------+--------+--------+--------+--------+--------+--------+--------+
```

#### 字段说明

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| Prefix | uint8 | 固定帧头，值为 `0x0C` | 0x0C |
| MsgID | uint32 | 消息ID，小端序，自增 | 0x00000001 |
| Control | uint8 | 控制码，通常为 `0x01` | 0x01 |
| Length | uint16 | 数据长度（包含Type字段的2字节），小端序，重复两次 | 0x001C |
| Type | uint16 | 请求类型，小端序 | 0x000D (连接) |
| Data | bytes | 数据域，变长 | 变长 |

#### 示例

```
0C 01 00 00 00 01 1C 00 1C 00 0D 00 01
│  │           │  │  │  │  │  │  └─ Data: 0x01
│  │           │  │  │  │  └─└─ Type: 0x000D (连接)
│  │           │  │  └─└─ Length: 0x001C (重复)
│  │           └─└─ Length: 0x001C
│  └─ Control: 0x01
└─ Prefix: 0x0C
   MsgID: 0x00000001 (小端序)
```

### 响应帧（Response Frame）

响应帧由服务器返回给客户端，格式如下：

```
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
| Prefix | Control| MsgID  |Unknown | Type   |ZipLen  | Length | Data   |
| (4字节) | (1字节) | (4字节) | (1字节) | (2字节) | (2字节) | (2字节) | (变长) |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
```

#### 字段说明

| 字段 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| Prefix | uint32 | 固定帧头，值为 `0xB1CB7400`（小端序） | 0xB1CB7400 |
| Control | uint8 | 控制码，`0x1C`表示成功，`0x0C`表示错误 | 0x1C |
| MsgID | uint32 | 消息ID，对应请求的MsgID，小端序 | 0x00000001 |
| Unknown | uint8 | 未知字段，通常为 `0x00` | 0x00 |
| Type | uint16 | 响应类型，对应请求的Type，小端序 | 0x000D |
| ZipLength | uint16 | 压缩数据长度，小端序 | 0x0051 |
| Length | uint16 | 未压缩数据长度，小端序 | 0x00BD |
| Data | bytes | 数据域，可能为zlib压缩数据 | 变长 |

#### 数据解压

- 如果 `ZipLength == Length`，数据未压缩
- 如果 `ZipLength != Length`，数据使用 zlib 压缩，需要解压
- 解压后的数据长度应等于 `Length`

#### 示例

```
B1 CB 74 00 1C 00 00 00 00 00 0D 00 51 00 BD 00 [压缩数据...]
│           │  │           │  │  │  │  │  └─ Length: 0x00BD
│           │  │           │  │  │  └─ ZipLength: 0x0051
│           │  │           │  └─└─ Type: 0x000D
│           │  └─ Unknown: 0x00
│           └─ MsgID: 0x00000000
└─ Control: 0x1C (成功)
   Prefix: 0xB1CB7400
```

---

## 消息类型

### 消息类型常量

| 类型值 | 常量名 | 说明 |
|--------|--------|------|
| 0x000D | TypeConnect | 建立连接 |
| 0x0004 | TypeHeart | 心跳包 |
| 0x000F | TypeGbbq | 除权除息 |
| 0x044E | TypeCount | 获取股票数量 |
| 0x0450 | TypeCode | 获取股票代码列表 |
| 0x053E | TypeQuote | 行情信息（5档报价） |
| 0x051D | TypeMinute | 分时数据 |
| 0x056A | TypeCallAuction | 集合竞价 |
| 0x0FC5 | TypeMinuteTrade | 分时成交 |
| 0x0FB4 | TypeHistoryMinute | 历史分时数据 |
| 0x0FB5 | TypeHistoryMinuteTrade | 历史分时成交 |
| 0x052D | TypeKline | K线数据 |

### K线类型

| 类型值 | 常量名 | 说明 |
|--------|--------|------|
| 0 | TypeKline5Minute | 5分钟K线 |
| 1 | TypeKline15Minute | 15分钟K线 |
| 2 | TypeKline30Minute | 30分钟K线 |
| 3 | TypeKline60Minute | 60分钟K线（1小时） |
| 4 | TypeKlineDay2 | 日K线（需除以100） |
| 5 | TypeKlineWeek | 周K线 |
| 6 | TypeKlineMonth | 月K线 |
| 7 | TypeKlineMinute | 1分钟K线 |
| 8 | TypeKlineMinute2 | 1分钟K线（变体） |
| 9 | TypeKlineDay | 日K线 |
| 10 | TypeKlineQuarter | 季K线 |
| 11 | TypeKlineYear | 年K线 |

### 交易所类型

| 值 | 常量名 | 说明 |
|----|--------|------|
| 0 | ExchangeSZ | 深圳交易所 |
| 1 | ExchangeSH | 上海交易所 |
| 2 | ExchangeBJ | 北京交易所 |

---

## 数据编码规则

### 字节序

所有多字节数值均使用**小端序**（Little-Endian）编码。

### 变长整数编码（Varint）

协议中使用变长整数编码来节省空间，规则如下：

- **第一字节**：
  - 第7位（最高位）：`0x80`，表示是否有后续字节（1=有，0=无）
  - 第6位：`0x40`，表示符号（1=负，0=正）
  - 低6位：有效数据位

- **后续字节**：
  - 第7位：`0x80`，表示是否有后续字节
  - 低7位：有效数据位

#### 解码算法

```go
func getData(bs []byte) int32 {
    data := int32(0)
    for i := range bs {
        if i == 0 {
            // 第一字节：取低6位
            data += int32(bs[0] & 0x3F)
        } else {
            // 后续字节：取低7位，左移相应位数
            data += int32(bs[i] & 0x7F) << uint8(6 + (i-1)*7)
        }
        // 判断是否有后续数据
        if bs[i] & 0x80 == 0 {
            break
        }
    }
    // 第一字节的第6位为1表示负数
    if len(bs) > 0 && bs[0] & 0x40 > 0 {
        data = -data
    }
    return data
}
```

#### 示例

- `0x20` → 32（正数，无后续）
- `0xA0` → -32（负数，无后续）
- `0x9F 0x01` → 159（正数，有后续）

### 价格编码

价格使用变长整数编码，单位为**厘**（1元 = 1000厘）。

- 价格值 = `getData(bs)` × 10（转换为厘）
- 在K线数据中，价格是相对于前一个价格的差值

### 成交量编码

成交量使用特殊的浮点数编码（4字节uint32），通过指数和对数计算：

```go
func getVolume(val uint32) float64 {
    ivol := int32(val)
    logpoint := ivol >> 24           // 最高字节
    hleax := (ivol >> 16) & 0xff     // 次高字节
    lheax := (ivol >> 8) & 0xff      // 第三字节
    lleax := ivol & 0xff              // 最低字节
    
    // 复杂的指数计算...
    // 返回浮点数成交量
}
```

### 字符编码

- **股票代码**: ASCII 字符串，6字节
- **股票名称**: GBK/GB18030 编码，需要转换为 UTF-8
- **时间**: 特殊编码格式（见下文）

### 时间编码

#### K线时间编码

**分钟K线**（1分钟、5分钟、15分钟、30分钟、60分钟）：
- 4字节：`[YearMonthDay(2字节)] [HourMinute(2字节)]`
- YearMonthDay: `year = (val >> 11) + 2004`, `month = (val % 2048) / 100`, `day = (val % 2048) % 100`
- HourMinute: `hour = val / 60`, `minute = val % 60`

**日K线及以上**（日、周、月、季、年）：
- 4字节：`YYYYMMDD` 格式（小端序）
- 时间固定为 15:00:00

#### 分时成交时间编码

- 2字节：`[HourMinute]`
- HourMinute: `hour = val / 60`, `minute = val % 60`
- 日期从请求参数中获取

---

## 业务消息格式

### 1. 建立连接（TypeConnect）

#### 请求格式

```
Data: [0x01]
```

#### 响应格式

```
Data: [68字节未知] + [GBK字符串信息]
```

- 前68字节用途未知
- 后续为GBK编码的字符串信息

---

### 2. 心跳包（TypeHeart）

#### 请求格式

```
Data: [] (空)
```

#### 响应

通常无响应或返回简单确认。

---

### 3. 获取股票数量（TypeCount）

#### 请求格式

```
Data: [Exchange(1)] [0x00] [0x75] [0xC7] [0x33] [0x01]
```

- Exchange: 交易所类型（0=深圳，1=上海，2=北京）
- 后4字节用途未知

#### 响应格式

```
Data: [Count(2字节，小端序)]
```

---

### 4. 获取股票代码列表（TypeCode）

#### 请求格式

```
Data: [Exchange(1)] [0x00] [Start(2字节，小端序)]
```

- Exchange: 交易所类型
- Start: 起始索引（一次返回1000只）

#### 响应格式

```
Data: [Count(2字节)] + [Code结构 × Count]
```

**Code结构**（29字节）：
```
+--------+--------+--------+--------+--------+--------+--------+--------+
| Code   | Multiple| Name  | ...   | Decimal| LastPrice| ... |
| (6字节) | (2字节)  | (8字节)| (4字节) | (1字节) | (4字节)  | (4字节) |
+--------+--------+--------+--------+--------+--------+--------+--------+
```

- Code: 股票代码（ASCII，6字节）
- Multiple: 倍数，通常为100（0x64）
- Name: 股票名称（GBK，8字节）
- Decimal: 小数点位数，通常为2
- LastPrice: 昨收价格（特殊编码，4字节）

---

### 5. 行情信息（TypeQuote）- 5档报价

#### 请求格式

```
Data: [0x05] [0x00] [0x00] [0x00] [0x00] [0x00] [0x00] [0x00] [0x00]
      + [Count(2字节)] + [Exchange(1) + Code(6)] × Count
```

- 前8字节固定为 `05 00 00 00 00 00 00 00`
- Count: 请求的股票数量
- Exchange + Code: 每个股票的交易所和代码

#### 响应格式

```
Data: [2字节未知] + [Count(2字节)] + [Quote结构 × Count]
```

**Quote结构**：
```
+--------+--------+--------+--------+--------+--------+--------+
| Exchange| Code  | Active1| K(6字节)| Time   | ...   | Buy/Sell|
| (1字节)  | (6字节) | (2字节) |        | (4字节) |        | (50字节)|
+--------+--------+--------+--------+--------+--------+--------+
```

主要字段：
- Exchange: 交易所
- Code: 股票代码
- Active1: 活跃度
- K: K线数据（昨收、今开、最高、最低、今收）
- ServerTime: 服务器时间
- TotalHand: 总手
- Intuition: 现量
- Amount: 金额
- InsideDish: 内盘
- OuterDisc: 外盘
- BuyLevel: 5档买盘（买1-5）
- SellLevel: 5档卖盘（卖1-5）

**5档报价结构**（每档10字节）：
```
+--------+--------+--------+--------+
| BuyPrice| SellPrice| BuyVol| SellVol|
| (变长)  | (变长)    | (变长)| (变长) |
+--------+--------+--------+--------+
```

- 买/卖价格是相对于收盘价的差值（变长编码）
- 实际价格 = 差值 × 10 + 收盘价

---

### 6. 分时数据（TypeMinute）

#### 请求格式

```
Data: [Exchange(1)] [0x00] [Code(6)] [0x00] [0x00] [0x00] [0x00]
```

#### 响应格式

```
Data: [Count(2字节)] + [4字节未知] + [PriceNumber结构 × Count]
```

**PriceNumber结构**：
```
+--------+--------+--------+
| Price  | Unknown| Number |
| (变长) | (变长)  | (变长) |
+--------+--------+--------+
```

- Price: 价格（变长编码）
- Number: 成交量（手，变长编码）
- Time: 时间从09:00开始，每分钟递增，第120分钟后跳到13:01

---

### 7. K线数据（TypeKline）

#### 请求格式

```
Data: [Exchange(1)] [0x00] [Code(6)] [Type(1)] [0x00] [0x01] [0x00]
      + [Start(2字节)] + [Count(2字节)] + [10字节未知]
```

- Exchange: 交易所
- Code: 股票代码（6字节ASCII）
- Type: K线类型（0-11）
- Start: 起始位置
- Count: 请求数量（最大800）

#### 响应格式

```
Data: [Count(2字节)] + [Kline结构 × Count]
```

**Kline结构**：
```
+--------+--------+--------+--------+--------+--------+--------+--------+
| Time   | Open  | Close  | High   | Low    | Volume | Amount | ...    |
| (4字节) | (变长) | (变长) | (变长) | (变长) | (4字节) | (4字节) | (4字节) |
+--------+--------+--------+--------+--------+--------+--------+--------+
```

- Time: 时间（4字节，特殊编码）
- Open/Close/High/Low: 价格差值（变长编码）
  - 实际价格 = Last + Open + Close（累加计算）
- Volume: 成交量（特殊编码，4字节）
  - 分钟K线需要除以100
  - 指数需要乘以100
- Amount: 成交额（特殊编码，4字节，单位：厘）
- 指数数据额外包含：UpCount（上涨数量）、DownCount（下跌数量）

---

### 8. 分时成交（TypeMinuteTrade）

#### 请求格式

```
Data: [Exchange(1)] [0x00] [Code(6)] + [Start(2字节)] + [Count(2字节)]
```

#### 响应格式

```
Data: [Count(2字节)] + [4字节未知] + [Trade结构 × Count]
```

**Trade结构**：
```
+--------+--------+--------+--------+--------+--------+
| Time   | Price  | Volume | Status | Number | Unknown|
| (2字节) | (变长) | (变长) | (变长) | (变长) | (变长) |
+--------+--------+--------+--------+--------+--------+
```

- Time: 时间（HourMinute格式，2字节）
- Price: 价格差值（变长编码，单位：分，需转换为厘）
- Volume: 成交量（手，变长编码）
- Status: 状态（0=买入，1=卖出，2=中性/汇总）
- Number: 单数（历史数据无效）

---

### 9. 历史分时成交（TypeHistoryMinuteTrade）

#### 请求格式

```
Data: [Date(4字节，YYYYMMDD格式)] + [Exchange(1)] [0x00] [Code(6)]
      + [Start(2字节)] + [Count(2字节)]
```

#### 响应格式

与分时成交相同，但Number字段无效。

---

### 10. 历史分时数据（TypeHistoryMinute）

#### 请求格式

```
Data: [Date(4字节)] + [Exchange(1)] [0x00] [Code(6)]
```

#### 响应格式

与分时数据相同。

---

### 11. 集合竞价（TypeCallAuction）

#### 请求格式

```
Data: [Exchange(1)] [0x00] [Code(6)] + [其他字段]
```

#### 响应格式

包含集合竞价的价格和成交量信息。

---

### 12. 除权除息（TypeGbbq）

#### 请求格式

```
Data: [Exchange(1)] [0x00] [Code(6)]
```

#### 响应格式

包含除权除息信息列表。

---

## 连接与心跳

### 连接建立

1. **TCP连接**: 客户端连接到服务器（IP:Port，默认7709）
2. **发送连接请求**: 立即发送TypeConnect消息
3. **接收响应**: 等待服务器响应
4. **启动心跳**: 连接成功后，每30秒发送一次心跳包

### 心跳机制

- **间隔**: 30秒
- **超时**: 60秒无数据则断开连接
- **消息类型**: TypeHeart (0x0004)
- **数据**: 空

### 消息ID管理

- 每个请求都有唯一的MsgID（uint32，自增）
- 响应中的MsgID与请求的MsgID对应
- 用于异步请求-响应匹配

### 错误处理

- Control字段为 `0x0C` 表示错误
- Control字段为 `0x1C` 表示成功
- 可以通过检查Control字段判断请求是否成功

---

## 注意事项

1. **字节序**: 所有多字节数值均为小端序
2. **压缩**: 响应数据可能使用zlib压缩，需要检查ZipLength和Length
3. **编码**: 股票名称使用GBK/GB18030编码，需要转换为UTF-8
4. **价格单位**: 价格为厘（1元=1000厘）
5. **成交量单位**: 成交量为手（1手=100股）
6. **时间处理**: 注意不同K线类型的时间编码方式不同
7. **变长编码**: 价格和数量使用变长整数编码，需要正确解析
8. **K线价格**: K线中的价格是差值，需要累加计算
9. **成交量编码**: 成交量使用特殊的浮点数编码，需要特殊处理
10. **连接管理**: 需要维护心跳，避免连接超时断开

---

## 参考资源

- [injoyai/tdx](https://github.com/injoyai/tdx) - Go语言实现
- [gotdx](https://github.com/bensema/gotdx) - 参考实现
- [mootdx](https://github.com/mootdx/mootdx) - 参考实现

---

**文档版本**: 1.0  
**最后更新**: 2025-01-10  
**基于**: injoyai/tdx 项目源码分析
